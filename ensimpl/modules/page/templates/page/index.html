{% extends 'layouts/base.html' %}

{% block title %}ensimpl{% endblock %}

{% block head %}
<link rel="stylesheet"
      href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">

<link rel="stylesheet"
      href="//cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
{% endblock %}

{% block body %}

{% include 'page/nav.html' %}

<div class="container-fluid">

    <h1>ensimpl</h1>
    <p class="lead">The ensimpl API was built by <a href="//churchill-lab.jax.org">The Churchill Lab</a> to simplify annotating various data from <a href="//www.ensembl.org">Ensembl</a>.</p>

</div>

{% endblock %}

{% block javascript %}
    <script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="//cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
    <script src="{{ url_for('api.ensimpl_js') }}"></script>

<script>
    <!--
    /**
     * Perform Ensimpl search.
     */
    function findGene() {
        let searchVal = $("#searchTerm").val().trim().toUpperCase();
        let version = $("#selectVersion").val();
        let species = $("#selectSpecies").val();

        $("#tblBody").html('');

        if (searchVal.length === 0) {
            return;
        }

        let options = {species: species,
                       limit: 100};

        if (version !== "") {
            options['version'] = version;
        }
        //window.ENSIMPL.reconfigure(settings);

        window.ENSIMPL.search(searchVal, options, function (data) {
            console.log('data=', data);
            $.each(data.result.matches, function(idx, elem) {
                $("#tblBody").append('<tr>' +
                                     '<td>' + elem.ensembl_gene_id + '</td>' +
                                     '<td>' + elem.symbol + '</td>' +
                                     '<td class="d-none d-md-table-cell">' + elem.chromosome + ':' + elem.position_start + '-' + elem.position_end + '</td>' +
                                     '<td class="d-none d-xl-table-cell">' + elem.match_reason + '</td>' +
                                     '<td class="d-none d-xl-table-cell">' + elem.name + '</td>' +
                                     '</tr>');
            });
        });
    }

    $().ready(function () {

        window.ENSIMPL = new ensimpl();

        window.ENSIMPL.versions(function(data) {
            let versions = {};
            let species = {};

           $.each(data, function(idx, elem) {
               versions[elem['version']] = +elem['version'];
               species[elem['species']] = elem['species'];
           });

           let vals = Object.values(versions);
           vals.sort().reverse();

           $.each(vals, function(key, val) {
               $("#selectVersion").append('<option value="' + val + '">' + val + '</option>')
           });

           $.each(species, function(key, val) {
               $("#selectSpecies").append('<option value="' + key + '">' + val + '</option>')
           });

        });

        $('#searchTerm').keypress(function (evt) {
            let code = evt.which ? evt.which : evt.keyCode;
            if (code === 13) {
                $(this).blur();
                $('#btnGo').focus().click();
            }
        });

        $('#btnGo').button().on('click', function (evt) {
            evt.preventDefault();
            findGene();
            console.log('findGene');
            return false;
        });
    });
    //-->
</script>

{% endblock %}
