{% extends 'base.html' %}

{% block title %}ensimpl Lookup{% endblock %}

{% block head %}
{% endblock %}

{% block body %}

 {% include 'nav.html' %}



    <div class="container-fluid h-100">

    <h1>ensimpl ID Lookup</h1>
    <p class="lead">Batch Ensembl ID lookup utilizing the ensimpl API.</p>

    <div class="row">
        <div class="col">

            <div class="row h-100">
                <div class="col">

                    <div class="card bg-light h-100">
                        <div class="card-header font-weight-bold">ensimpl Input</div>
                        <div class="card-body">
                            <div class="form-group row">
                                <label for="selectSpecies" class="col-4 col-form-label">Species</label>
                                <div class="col-8">
                                    <select class="form-control  form-control-sm" id="selectSpecies">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="selectRelease" class="col-4 col-form-label">Release</label>
                                <div class="col-8">
                                    <select class="form-control  form-control-sm" id="selectRelease">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="fields" class="col-4 col-form-label">IDs</label>
                                <div class="col-8">
                                    <textarea id="identifiers" class="form-control form-control-sm" rows="7"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="float-right small">
                                        <a href="#" id="exampleData"><i class="fas fa-list"></i> Example Data</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-footer text-muted">
                            <span class="input-group-btn">
                                <button class="btn btn-secondary" id="btnGo" type="button">Go!</button>
                            </span>
                        </div>

                    </div>

                </div>

                <div class="col">

                    <div class="row h-100">
                        <div class="col">

                            <div class="card bg-light h-100">
                                <div class="card-header font-weight-bold">Download Settings</div>
                                <div class="card-body">
                                    <div class="form-group row">
                                        <label for="emptystring" class="col-4 col-form-label">Empty String</label>
                                        <div class="col-8">
                                            <select class="form-control  form-control-sm" id="emptystring">
                                                <option value="" selected>"" (Empty String)</option>
                                                <option value="NA">NA</option>
                                                <option value="None">None</option>
                                            </select>
                                        </div>
                                    </div>

                            <div class="form-group row">
                                <label for="fields" class="col-4 col-form-label">Output Fields</label>
                                <div class="col-8">

                                    <!--

                                    <div class="form-check">
                                      <input class="form-check-input" type="checkbox" value="input_id" id="column_input_id">
                                      <label class="form-check-label" for="column_input_id">
                                        Input ID
                                      </label>
                                    </div>
                                    //-->
                                    <div class="form-check m-0">
                                        <input class="form-check-input" type="checkbox" checked="checked" value="gene_id" id="column_gene_id">
                                        <label class="form-check-label" for="column_gene_id">
                                            Gene ID
                                        </label>
                                    </div>
                                    <div class="form-check m-0">
                                        <input class="form-check-input" type="checkbox" checked="checked" value="symbol" id="column_gene_symbol">
                                        <label class="form-check-label" for="column_gene_symbol">
                                            Gene Symbol
                                        </label>
                                    </div>
                                    <div class="form-check m-0">
                                        <input class="form-check-input" type="checkbox" checked="checked" value="description" id="column_gene_description">
                                        <label class="form-check-label" for="column_gene_description">
                                            Gene Description
                                        </label>
                                    </div>
                                    <div class="form-check m-0">
                                        <input class="form-check-input" type="checkbox" checked="checked" value="location" id="column_gene_location">
                                        <label class="form-check-label" for="column_gene_location">
                                            Gene Location
                                        </label>
                                    </div>
                                    <div class="form-check m-0">
                                        <input class="form-check-input" type="checkbox" checked="checked" value="strand" id="column_gene_strand">
                                        <label class="form-check-label" for="column_gene_strand">
                                            Gene Strand
                                        </label>
                                    </div>
                                    <div class="form-check m-0">
                                        <input class="form-check-input" type="checkbox" checked="checked" value="synonyms" id="column_gene_synonyms">
                                        <label class="form-check-label" for="column_gene_synonyms">
                                            Gene Synonyms
                                        </label>
                                    </div>
                                    <div class="form-check m-0">
                                        <input class="form-check-input" type="checkbox" checked="checked" value="external_ids" id="column_external_ids">
                                        <label class="form-check-label" for="column_external_ids">
                                            External ID
                                        </label>
                                    </div>
                                    <div class="form-check m-0">
                                        <input class="form-check-input" type="checkbox" checked="checked" value="homolog_ids" id="column_homolog_ids">
                                        <label class="form-check-label" for="column_homolog_ids">
                                            Homolog IDs
                                        </label>
                                    </div>
                                    <!--
                                    <select class="form-control form-control-sm" id="fields" multiple>
                                        <option value="input_id" selected>Input ID</option>
                                        <option value="gene_id" selected>Gene ID</option>
                                        <option value="gene_symbol" selected>Gene Symbol</option>
                                        <option value="gene_description" selected>Gene Description</option>
                                        <option value="gene_location" selected>Gene Location</option>
                                        <option value="gene_strand">Gene Strand</option>
                                        <option value="gene_synonyms">Gene Synonyms</option>
                                        <option value="external_id">External ID</option>
                                    </select>
                                    //-->
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-1">
                                </div>

                                <div class="col-11">


                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" checked="checked" value="" id="include_all">
                                            <label class="form-check-label active" for="include_all">
                                                Include input IDs that are not found
                                            </label>
                                        </div>


                                </div>
                            </div>
                                </div>

                                <div class="card-footer text-muted">
                                    <span class="input-group-btn">
                                        <button class="btn btn-secondary" id="btnDL" type="button">Download</button>
                                    </span>
                                </div>

                            </div>

                        </div>
                    </div>

                </div>



            </div>




        </div>


    </div>

    <br/>

                    <div class="row">
                        <div class="col">


                            <div id="searchStatus"></div>
                            <div id="searchTable"></div>
                        </div>
                    </div>



</div>

{% endblock %}

{% block javascript %}
<script src="{{ app.state.url_prefix }}/js/ensimpl.js"></script>


<script>

    <!--

    function nvl(val, def) {
        if (val === '') {
            return def;
        }

        return val;
    }

    /**
     * Perform Ensimpl search.
     */
    function findGene() {
        let identifiers = $("#identifiers").val().trim().toUpperCase().split("\n");
        let species = $("#selectSpecies").val();
        let release = $("#selectRelease").val();

        $("#searchTable").html('');

        if (identifiers.length === 0) {
            identifiers = null;
        }

        let data = {
            'release': release,
            'species': species,
            'ids': identifiers
        };

        let selectionsTemp = $('[id^="column_"]');
        let selections = [];

        $.each(selectionsTemp, function(idx, elem) {
              if ($(elem).is(':checked')) {
                  selections.push(elem);
              }
        });

        if (selections.length === 0) {
            return;
        }


        $('#dl').hide();
        window.GENES = {};

        $.ajax({
              url: '{{ app.state.url_prefix }}/api/genes',
              type: "POST",
              data: JSON.stringify(data),
          }).done(function (data, textStatus, jqXHR) {
                console.log('data=', data);
                window.GENES = data.genes || {};
                let numGenes = 0;


                let h = '<table class="table table-striped"><thead><tr>';
                let defaultValue = $('#emptystring').val();


                h += '<th class="" scope="col">ID</th>';

                $.each(selections, function(idx, elem) {

                    if (elem.value === 'gene_id') {
                        h += '<th class="" scope="col">Gene ID</th>';
                    } else if (elem.value === 'symbol') {
                        h += '<th class="" scope="col">Symbol</th>';
                    } else if (elem.value === 'description') {
                        h += '<th class="" scope="col">Description</th>';
                    } else if (elem.value === 'location') {
                        h += '<th class="" scope="col">Location</th>';
                    } else if (elem.value === 'strand') {
                        h += '<th class="" scope="col">Strand</th>';
                    } else if (elem.value === 'synonyms') {
                        h += '<th class="" scope="col">Synonyms</th>';
                    } else if (elem.value === 'external_ids') {
                        h += '<th class="" scope="col">External ID</th>';
                    } else if (elem.value === 'homolog_ids') {
                        h += '<th class="" scope="col">Homolog IDs</th>';
                    }
                });

                h += '</tr></thead><tbody id="tblBody"></tbody></table>';

                $('#searchTable').html(h);

                $.each(identifiers, function(idx, lookup) {
                    let h2 = '';
                    //console.log(lookup);
                    h2 += '<td>' + lookup + '</td>';
                        if ((lookup in data.genes) || ($('#include_all').is(':checked'))) {
                            let elem = data.genes[lookup] || {};

                            $.each(selections, function(idx2, elem2) {

                                if (elem2.value === 'gene_id') {
                                    if ('id' in elem) {
                                        h2 += '<td>' + nvl(elem.id, defaultValue) + '</td>';
                                    } else {
                                        h2 += '<td>' + defaultValue + '</td>';
                                    }
                                } else if (elem2.value === 'symbol') {
                                    if ('symbol' in elem) {
                                        h2 += '<td>' + nvl(elem.symbol, defaultValue) + '</td>';
                                    } else {
                                        h2 += '<td>' + defaultValue + '</td>';
                                    }
                                } else if (elem2.value === 'description') {
                                    if ('name' in elem) {
                                        h2 += '<td>' + nvl(elem.name, defaultValue) + '</td>';
                                    } else {
                                        h2 += '<td>' + defaultValue + '</td>';
                                    }
                                } else if (elem2.value === 'location') {
                                    if (('chromosome' in elem) && ('start' in elem) && ('end' in elem)) {
                                        h2 += '<td>' + elem.chromosome + ':' + elem.start + '-' + elem.end + '</td>';
                                    } else {
                                        h2 += '<td>' + defaultValue + '</td>';
                                    }

                                } else if (elem2.value === 'strand') {
                                    if ('strand' in elem) {
                                        h2 += '<td>' + nvl(elem.strand, defaultValue) + '</td>';
                                    } else {
                                        h2 += '<td>' + defaultValue + '</td>';
                                    }
                                } else if (elem2.value === 'synonyms') {
                                    if ('synonyms' in elem) {
                                        let synonyms = elem['synonyms'].join(':');
                                        h2 += '<td>' + nvl(synonyms, defaultValue) + '</td>';
                                    } else {
                                        h2 += '<td>' + defaultValue + '</td>';
                                    }

                                } else if (elem2.value === 'external_ids') {
                                    if ('external_ids' in elem) {
                                        let external_ids = null;

                                        $.each(elem.external_ids, function(i, e) {
                                            if ((e['db'] === 'MGI') || (e['db'] === 'HGNC')) {
                                                external_ids = e['db_id'];
                                            }
                                        });

                                        h2 += '<td>' + nvl(external_ids, defaultValue) + '</td>';
                                    } else {
                                        h2 += '<td>' + defaultValue + '</td>';
                                    }
                                } else if (elem2.value === 'homolog_ids') {
                                    if ('homolog_ids' in elem) {
                                        let homolog_ids = [];

                                        $.each(elem.homolog_ids, function(i, e) {
                                            homolog_ids.push(e['id'] + ':' + e['symbol']);
                                        });

                                        let homologs = homolog_ids.join('<br>');

                                        h2 += '<td>' + nvl(homologs, defaultValue) + '</td>';
                                    } else {
                                        h2 += '<td>' + defaultValue + '</td>';
                                    }
                                }
                        });
                        $("#tblBody").append('<tr>' + h2 + '</tr>');
                        numGenes++;
                    }


                });

                let message = '';

                if (identifiers.length > 0) {
                    message = identifiers.length + ' identifiers entered, ';
                }

                numGenes = Object.keys(window.GENES).length;

                if (numGenes === 0) {
                    message += 'No matches found';
                    $('#dl').hide();
                } else if (numGenes === 1) {
                    message += '1 match found';
                    $('#dl').show();
                } else {
                    message += numGenes + ' matches found';
                    $('#dl').show();
                }

                $("#searchStatus").html(message);

          }).fail(function (jqXHR, textStatus, errorThrown) {
              console.error('Ensimpl fail');
              console.error('jqXHR', jqXHR);
              console.error('textStatus', textStatus);
              console.error('errorThrown', errorThrown);
          });


    }


    function onSelected(selection) {
        $("#searchTerm").val(selection.chr + ":" + selection.start + "-" + selection.end);
        findGene();
    }

    function loadData(data, fileName) {
        //var blob = new Blob(["Hello, world!"], {type: "text/plain;charset=utf-8"});
        //FileSaver.saveAs(blob, fileName);
    }

    function saveData(data, fileName) {
        var blob = new Blob(data, {type: "text/plain;charset=utf-8"});
        FileSaver.saveAs(blob, fileName);
    }

    function getDateString() {
        let date = new Date();
        let year = date.getFullYear();
        let month = `${date.getMonth() + 1}`.padStart(2, '0');
        let day =`${date.getDate()}`.padStart(2, '0');
        //let hours = today.getHours();
        //let minutes = today.getMinutes();
        //let seconds = today.getSeconds();
        return `${month}_${day}_${year}`
    }

    function grabExampleIDs(source_db, num) {
        let species = $("#selectSpecies").val();
        let release = $("#selectRelease").val();

        $.ajax({
              url: '{{ app.state.url_prefix }}/api/randomids',
              type: 'GET',
              data: {
                  source_db: source_db,
                  limit: num,
                  release: release,
                  species: species
              }
        }).done(function (data, textStatus, jqXHR) {
            $('#identifiers').val(data.ids.join('\n'));
        });
    }



    $().ready(function () {
        $("#dl").hide();

        window.GENES = null;

        window.ENSIMPL = new ensimpl();

        window.ENSIMPL.releases(function(data) {
            window.ENSIMPL_RELEASES = {};
            let species = {};

            $.each(data, function(idx, elem) {
                window.ENSIMPL_RELEASES[elem['release']] = elem;
                species[elem['species']] = elem['species'];
            });

            let vals = Object.values(window.ENSIMPL_RELEASES);
            vals.sort().reverse();

            $.each(vals, function(key, val) {
                $("#selectRelease").append('<option value="' + val.release + '">' + val.release + ' - ' + val.assembly_patch + '</option>')
            });


           $.each(species, function(key, val) {
               $("#selectSpecies").append('<option value="' + key + '">' + val + '</option>')
           });

           $('#selectSpecies').val('Mm');
        });

        $('#exampleData').on('click', function(evt) {
            evt.preventDefault();
            grabExampleIDs('Ensembl', 10);
            return false;

        });


        $('#btnGo').button().on('click', function (evt) {
            evt.preventDefault();
            findGene();
            console.log('findGene');
            return false;
        });

        $('#btnDL').button().on('click', function (evt) {
            evt.preventDefault();

            let defaultValue = $('#emptystring').val();
            let header = ['"ID"'];
            let selectionsTemp = $('[id^="column_"]');
            let selections = [];

            $.each(selectionsTemp, function(idx, elem) {
                  if ($(elem).is(':checked')) {
                      selections.push(elem);
                  }
            });

            if (selections.length === 0) {
                return;
            }

            $.each(selections, function(idx, elem) {
                if (elem.value === 'gene_id') {
                    header.push('"Gene ID"');
                } else if (elem.value === 'symbol') {
                    header.push('"Gene Symbol"');
                } else if (elem.value === 'description') {
                    header.push('"Gene Description"');
                } else if (elem.value === 'location') {
                    header.push('"Gene Chromosome"');
                    header.push('"Gene Start"');
                    header.push('"Gene End"');
                } else if (elem.value === 'strand') {
                    header.push('"Gene Strand"');
                } else if (elem.value === 'synonyms') {
                    header.push('"Gene Synonyms"');
                } else if (elem.value === 'external_ids') {
                    header.push('"External ID"');
                } else if (elem.value === 'homolog_ids') {
                    header.push('"Homolog IDs"');
                }
            });

            let data = header.join("\t") + '\n';

            let identifiers = $("#identifiers").val().trim().toUpperCase().split("\n");

            $.each(identifiers, function(idx, lookup) {
                if ((lookup in window.GENES) || ($('#include_all').is(':checked'))) {
                    let elem = window.GENES[lookup] || {};

                    //console.log(elem);

                    let val = ['"' + lookup + '"'];

                    $.each(selections, function(idx2, elem2) {

                        if (elem2.value === 'gene_id') {
                            if ('id' in elem) {
                                val.push('"' + nvl(elem.id, defaultValue) + '"');
                            } else {
                                val.push('"' + defaultValue + '"');
                            }
                        } else if (elem2.value === 'symbol') {
                            if ('symbol' in elem) {
                                val.push('"' + nvl(elem.symbol, defaultValue) + '"');
                            } else {
                                val.push('"' + defaultValue + '"');
                            }
                        } else if (elem2.value === 'description') {
                            if ('name' in elem) {
                                val.push('"' + nvl(elem.name, defaultValue) + '"');
                            } else {
                                val.push('"' + defaultValue + '"');
                            }
                        } else if (elem2.value === 'location') {
                            if (('chromosome' in elem) && ('start' in elem) && ('end' in elem)) {
                                val.push('"' + elem.chromosome + '"');
                                val.push(elem.start);
                                val.push(elem.end);
                            } else {
                                val.push('"' + defaultValue + '"');
                            }
                        } else if (elem2.value === 'strand') {
                            if ('strand' in elem) {
                                val.push('"' + nvl(elem.strand, defaultValue) + '"');
                            } else {
                                val.push('"' + defaultValue + '"');
                            }
                        } else if (elem2.value === 'synonyms') {
                            if ('synonyms' in elem) {
                                val.push('"' + nvl(elem.synonyms.join(':'), defaultValue) + '"');
                            } else {
                                val.push('"' + defaultValue + '"');
                            }
                        } else if (elem2.value === 'external_ids') {

                            if ('external_ids' in elem) {
                                let external_ids = null;

                                $.each(elem.external_ids, function(i, e) {
                                    if ((e['db'] === 'MGI') || (e['db'] === 'HGNC')) {
                                        external_ids = e['db_id'];
                                    }
                                });

                                val.push('"' + nvl(external_ids, defaultValue) + '"');
                            } else {
                                val.push('"' + defaultValue + '"');
                            }
                        } else if (elem2.value === 'homolog_ids') {
                            if ('homolog_ids' in elem) {
                                let homolog_ids = [];

                                $.each(elem.homolog_ids, function (i, e) {
                                    homolog_ids.push(e['id'] + ':' + e['symbol']);
                                });

                                let homologs = homolog_ids.join('/');

                                val.push('"' + nvl(homologs, defaultValue) + '"');
                            } else {
                                val.push('"' + defaultValue + '"');
                            }
                        }
                    });

                    data += (val.join('\t') + '\n');
                }
            });

            let fileName = "ensimpl_lookup_" + $("#selectVersion").val() + "_" + getDateString() + ".tsv";


            saveAs(new Blob([data]), fileName);
            return false;
        });


    });
    //-->
</script>

{% endblock %}

